name: Deploy New Netlify App

on:
  push:
    branches: [main]
    paths:
      - 'apps.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-new-apps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find undeployed apps
        id: find
        run: |
          UNDEPLOYED=$(jq -r '.apps[] | select(.url == null or .url == "") | .folder' apps.json)
          echo "folders<<EOF" >> $GITHUB_OUTPUT
          echo "$UNDEPLOYED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Netlify sites for undeployed apps
        if: steps.find.outputs.folders != ''
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_TEAM_ID: ${{ secrets.NETLIFY_TEAM_ID }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Helper: pretty-print a response body, falling back to raw if not JSON
          log_response() {
            local body="$1"
            if echo "$body" | jq -e . > /dev/null 2>&1; then
              echo "$body" | jq .
            else
              echo "(non-JSON body) $body"
            fi
          }

          # Fetch the GitHub App installation ID linked to this Netlify account
          echo "Fetching GitHub App installation ID from Netlify..."
          INSTALL_RAW=$(curl -s -w "\n%{http_code}" \
            "https://api.netlify.com/api/v1/github_apps/installations" \
            -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN")
          INSTALL_HTTP=$(echo "$INSTALL_RAW" | tail -1)
          INSTALL_BODY=$(echo "$INSTALL_RAW" | head -n -1)

          echo "Netlify installations API — HTTP $INSTALL_HTTP"
          if ! echo "$INSTALL_BODY" | jq -e . > /dev/null 2>&1; then
            echo "ERROR: Netlify API returned a non-JSON response (HTTP $INSTALL_HTTP):"
            echo "$INSTALL_BODY"
            exit 1
          fi

          INSTALL_ID=$(echo "$INSTALL_BODY" | jq -r '.[0].github_app_installation_id')

          if [ -z "$INSTALL_ID" ] || [ "$INSTALL_ID" = "null" ]; then
            echo "ERROR: Could not retrieve GitHub App installation ID from Netlify account"
            echo "Response body:"
            echo "$INSTALL_BODY" | jq .
            exit 1
          fi
          echo "GitHub App installation ID: $INSTALL_ID"

          while IFS= read -r FOLDER; do
            [ -z "$FOLDER" ] && continue

            echo "──────────────────────────────────────"
            echo "Processing folder: $FOLDER"

            # Guard: folder must exist in the repo
            if [ ! -d "apps/$FOLDER" ]; then
              echo "WARNING: apps/$FOLDER not found in repository — skipping"
              continue
            fi

            SITE_NAME="aisle-$FOLDER"
            echo "Creating Netlify site: $SITE_NAME"

            SITE_RAW=$(curl -s -w "\n%{http_code}" -X POST "https://api.netlify.com/api/v1/sites" \
              -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"$SITE_NAME\",
                \"account_slug\": \"$NETLIFY_TEAM_ID\",
                \"repo\": {
                  \"provider\": \"github\",
                  \"repo\": \"$GITHUB_REPO\",
                  \"private\": false,
                  \"branch\": \"main\",
                  \"base_dir\": \"apps/$FOLDER\",
                  \"cmd\": \"echo 'Static site - no build needed'\",
                  \"dir\": \".\",
                  \"installation_id\": $INSTALL_ID
                }
              }")
            SITE_HTTP=$(echo "$SITE_RAW" | tail -1)
            RESPONSE=$(echo "$SITE_RAW" | head -n -1)

            echo "Create site API — HTTP $SITE_HTTP"
            SITE_URL=$(echo "$RESPONSE" | jq -r '.ssl_url // empty' 2>/dev/null || true)

            if [ -z "$SITE_URL" ]; then
              echo "ERROR: Failed to create Netlify site for $FOLDER (HTTP $SITE_HTTP). API response:"
              log_response "$RESPONSE"
              echo "Skipping — url will remain empty so the next run can retry"
              continue
            fi

            echo "Site created: $SITE_URL"

            # Write the url back into apps.json for this entry
            TMP=$(jq \
              --arg folder "$FOLDER" \
              --arg url "$SITE_URL" \
              '.apps = [.apps[] | if .folder == $folder then .url = $url else . end]' \
              apps.json)
            echo "$TMP" > apps.json
            echo "apps.json updated with url for $FOLDER"

          done <<< "${{ steps.find.outputs.folders }}"

      - name: Commit updated apps.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps.json
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update apps.json with Netlify URLs for new apps [skip ci]"
          git push origin main
