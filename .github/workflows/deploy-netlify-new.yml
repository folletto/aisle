name: Deploy New Netlify App

on:
  push:
    branches: [main]
    paths:
      - 'apps.json'
  pull_request:
    paths:
      - 'apps.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-new-apps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find undeployed apps
        id: find
        run: |
          UNDEPLOYED=$(jq -r '.apps[] | select(.url == null or .url == "") | .folder' apps.json)
          echo "folders<<EOF" >> $GITHUB_OUTPUT
          echo "$UNDEPLOYED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Netlify sites for undeployed apps
        if: steps.find.outputs.folders != ''
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_TEAM_ID: ${{ secrets.NETLIFY_TEAM_ID }}
          NETLIFY_GITHUB_INSTALLATION_ID: ${{ secrets.NETLIFY_GITHUB_INSTALLATION_ID }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          while IFS= read -r FOLDER; do
            [ -z "$FOLDER" ] && continue

            echo "──────────────────────────────────────"
            echo "Processing folder: $FOLDER"

            # Guard: folder must exist in the repo
            if [ ! -d "apps/$FOLDER" ]; then
              echo "WARNING: apps/$FOLDER not found in repository — skipping"
              continue
            fi

            SITE_NAME="aisle-$FOLDER"
            echo "Creating Netlify site: $SITE_NAME"

            # Create the site with full GitHub repo linking.
            # `base` tells Netlify which subdirectory to treat as the project root;
            # Netlify will read netlify.toml from there and run the build within it.
            # NETLIFY_GITHUB_INSTALLATION_ID: find at
            #   github.com/settings/installations/<id>  (personal)
            #   github.com/organizations/<org>/settings/installations/<id>  (org)
            SITE_RAW=$(curl -s -w "\n%{http_code}" -X POST "https://api.netlify.com/api/v1/sites" \
              -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"$SITE_NAME\",
                \"account_slug\": \"$NETLIFY_TEAM_ID\",
                \"repo\": {
                  \"provider\": \"github\",
                  \"repo\": \"$GITHUB_REPO\",
                  \"private\": false,
                  \"branch\": \"main\",
                  \"base\": \"apps/$FOLDER\",
                  \"installation_id\": $NETLIFY_GITHUB_INSTALLATION_ID
                }
              }")
            SITE_HTTP=$(echo "$SITE_RAW" | tail -1)
            SITE_BODY=$(echo "$SITE_RAW" | head -n -1)

            echo "Create site API — HTTP $SITE_HTTP"

            if ! echo "$SITE_BODY" | jq -e . > /dev/null 2>&1; then
              echo "ERROR: Netlify API returned a non-JSON response (HTTP $SITE_HTTP):"
              echo "$SITE_BODY"
              echo "Skipping — url will remain empty so the next run can retry"
              continue
            fi

            SITE_ID=$(echo "$SITE_BODY" | jq -r '.id // empty')
            SITE_URL=$(echo "$SITE_BODY" | jq -r '.ssl_url // empty')

            if [ -z "$SITE_ID" ]; then
              echo "ERROR: Failed to create Netlify site for $FOLDER (HTTP $SITE_HTTP). API response:"
              echo "$SITE_BODY" | jq .
              echo "Skipping — url will remain empty so the next run can retry"
              continue
            fi

            echo "Site created: $SITE_URL (id: $SITE_ID)"

            # Write the url back into apps.json for this entry
            TMP=$(jq \
              --arg folder "$FOLDER" \
              --arg url "$SITE_URL" \
              '.apps = [.apps[] | if .folder == $folder then .url = $url else . end]' \
              apps.json)
            echo "$TMP" > apps.json
            echo "apps.json updated with url for $FOLDER"

          done <<< "${{ steps.find.outputs.folders }}"

      - name: Fix base directory for already-deployed sites
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: |
          set -euo pipefail

          # Ensure every site that follows the aisle-<folder> naming convention
          # has its base directory set correctly. This repairs sites that were
          # created before the base_dir → base fix and catches any future drift.
          DEPLOYED=$(jq -r '.apps[] | select(.url != null and .url != "") | .folder' apps.json)

          while IFS= read -r FOLDER; do
            [ -z "$FOLDER" ] && continue

            SITE_NAME="aisle-$FOLDER"
            EXPECTED_BASE="apps/$FOLDER"

            # Look up the site by name
            SITES=$(curl -s \
              "https://api.netlify.com/api/v1/sites?name=$SITE_NAME&filter=all" \
              -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN")

            SITE_ID=$(echo "$SITES" | jq -r --arg n "$SITE_NAME" \
              '.[] | select(.name == $n) | .id' | head -1)

            if [ -z "$SITE_ID" ]; then
              echo "Site $SITE_NAME not found on Netlify — skipping"
              continue
            fi

            CURRENT_BASE=$(echo "$SITES" | jq -r --arg n "$SITE_NAME" \
              '.[] | select(.name == $n) | .build_settings.base // ""' | head -1)

            if [ "$CURRENT_BASE" = "$EXPECTED_BASE" ]; then
              echo "$SITE_NAME base already correct: $CURRENT_BASE"
              continue
            fi

            echo "Fixing $SITE_NAME: base=\"$CURRENT_BASE\" → \"$EXPECTED_BASE\""
            PATCH_RAW=$(curl -s -w "\n%{http_code}" -X PATCH \
              "https://api.netlify.com/api/v1/sites/$SITE_ID" \
              -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"build_settings\": {\"base\": \"$EXPECTED_BASE\"}}")
            PATCH_HTTP=$(echo "$PATCH_RAW" | tail -1)
            PATCH_BODY=$(echo "$PATCH_RAW" | head -n -1)

            if [ "$PATCH_HTTP" = "200" ]; then
              echo "Fixed $SITE_NAME successfully"
            else
              echo "ERROR: Failed to fix $SITE_NAME (HTTP $PATCH_HTTP)"
              echo "$PATCH_BODY" | jq . || true
            fi

          done <<< "$DEPLOYED"

      - name: Commit updated apps.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps.json
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update apps.json with Netlify URLs for new apps [skip ci]"
          git push origin HEAD:${{ github.head_ref || github.ref_name }}
